{% extends 'base.html.twig' %}

{% block title %}Music Services Kenya{% endblock %}
{% block stylesheets %}

    <link rel="stylesheet" href="{{ asset('theme/assets/css/form-styles.css ') }}">
    <link rel="stylesheet" href="{{ asset('theme/assets/fonts/simple-line-icons.min.css ') }}">
    <link rel="stylesheet" href="{{ asset('theme/assets/css/Steps-Progressbar.css ') }}">
	<link rel="stylesheet" href="{{ asset('theme/assets/css/bootstrap-datepicker.min.css ') }}">
	<link rel="stylesheet" href="{{ asset('theme/assets/css/themes.css ') }}">

<style>
	input.form-control {
		border: none;
		border-bottom: 1px solid #777!important;
	}
	.referee-form input {
		border:none;
		width: 100%;
		color: #777 !important;
		font-size: .9rem !important;
	}
	#prof-pic {
		background-color: #fff;
	}
	.plc-hld-text {
		display: inline-block;
		background-color: rgb(224, 212, 212, 0.5)!important;
		min-height: 12px;
		border-radius: 10px;
		min-width: 100px;
	}
	.plc-hld-textarea {
		display: inline-block;
		background-color: rgb(224, 212, 212, 0.5)!important;
		min-height: 50px;
		border-radius: 10px;
		min-width: 300px;
	}
	.plc-hld-list {
		display: inline-block;
		background-color: rgb(224, 212, 212, 0.5)!important;
		min-height: 12px;
		border-radius: 10px;
		min-width: 100px;
	}
	.plc-hld-title {
		display: inline-block;
		background-color: rgb(224, 212, 212, 0.5)!important;
		min-height: 16px;
		border-radius: 10px;
		min-width: 100px;
	}
	span {
		padding: 0;
		margin: 0;
	}
	.btn-outline {
		margin-right: 0px;
		margin-left: 0px;
		width: 10px !important;
		padding: 0 10px;
	}
	.fa-pencil, .fa-trash {
		color:#e0e3e6;
	}
	.fa-pencil:hover {
		color: #3c7e91;
	}
	.fa-trash:hover {
		color: red;
	}
	.btn-danger {
		background-color: inherit !important;
		background-image: none !important;
		border: none !important;
	}
	.btn-danger:active{
		background-color: inherit !important;
		background-image: none !important;
		border: none !important;
		box-shadow: none !important;
	}
	.btn-danger:focus{
		background-color: inherit !important;
		background-image: none !important;
		border: none !important;
		box-shadow: none !important;
	}
	.btn-danger:not(.disabled):hover {
		background-color: inherit !important;
		background-image: none !important;
		border: none !important;
		box-shadow: none !important;
	}
	.btn-danger :not(:disabled):not(.disabled):focus{
		background-color: inherit !important;
		background-image: none !important;
		border: none !important;
		box-shadow: none !important;
	}
	:target {
		scroll-margin-top: 5rem;
	}
	</style>
{% if app.user == null or app.user != musician %}
<style>
	.for-user {
		display: none;
	}
	.referee-form h5 {
		font-family: inherit !important; 
		font-size: 1.1rem !important;
		font-weight: normal !important;
	}
</style>
{% endif %}
{% if app.user and app.user == musician %}
<style>
	.for-public {
		display: none;
	}
</style>
{% endif %}
{% endblock %}
{% block body %}
<div style="height: 100vh; position: relative; overflow-x:hidden;">
	{% if app.request.cookies.get('activity') is defined and app.request.cookies.get('activity') == "Preview" %}
		<div id="child" style="padding-bottom:100px; width: 100%;">
			{% include "webbuild/" ~ pdf_template %}		
		</div>
	{% else %}
	{% include "reusable/nav.html.twig" %}
	<div class="row" style="height: 100%; padding-top: 5px; border-top: 1px solid #f3e5e5;">
		<div id="sidebar" class="col-md-4" style="height: 100%; overflow: auto; padding-bottom:100px;">
			{% include "registration_process/info.html.twig" %}
			{% include "registration_process/jobs.html.twig" %}
			{% include "registration_process/education.html.twig" %}
			{% include "registration_process/skills.html.twig" %}
			{% include "registration_process/roles.html.twig" %}
			{% include "registration_process/projects.html.twig" %}
		</div>
		<div id="mainbar" class="col-md-8 d-none d-md-block" style="height: 100%;">
			{# {{ dump(app.request.cookies) }} #}
			<div class="d-none d-md-block"  id="child" style="padding-bottom:100px; width: 90%; margin: auto; height: 100%; overflow: auto;">
				{% include "webbuild/" ~ pdf_template %}		
			</div>
		</div>		
		<div style="position:absolute; top:45%; right: 5px;" class="d-md-none reload-and-preview form-group reg-action"><button class="btn btn-outline-info btn-lg" type="button" data-toggle="modal" data-target="#preview"><i class="fa fa-eye"></i></button></div>
	{# {% include "reusable/footer.html.twig" %} #}
	{% include "registration_process/resumemodal.html.twig" %}
	</div>
	{% endif %}
	<div class="modal fade" id="explain" role="dialog" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">How to save your info</h4><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div>
				<div class="modal-body">
					<p>Save one information at a time. After clicking on 'Save skill' for example, the fields will be cleared and you can add another skill. The same applies to the other steps.</p>
				</div>
				<div class="modal-footer"><button class="btn btn-light" type="button" data-dismiss="modal">OK</button></div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="editor" role="dialog" data-backdrop="static" data-keyboard="false" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Editor</h4><button type="button" class="close reload" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div>
				<div class="modal-body">
					<div class="embed-responsive embed-responsive-16by9" style=""><iframe id="editor-frame" class="embed-responsive-item" src=""></iframe></div>
				</div>
			</div>
		</div>
	</div>
	<input type="hidden" value="{{ app.user.email|length > 1 and app.user.phone|length > 1 and app.user.fullname|length > 1 ? 'true' : '' }}" id="saved" />
	</div>
	{% endblock %}

{% block javascripts %}

  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="{{ asset('theme/assets/js/bootstrap-datepicker.min.js')}}" type="text/javascript"></script>

	<script>

	function setCookie(name, value){
		document.cookie = name + "=" + value;
	}

	function getCookie(name) {
		const cookieValue = document.cookie
		.split('; ')
		.find(row => row.startsWith(name))
		.split('=')[1];

		return cookieValue;
	}
	function destroyCookie(name) { 
		document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
	}
	function checkCookie(name){
		if (document.cookie.split(';').some((item) => item.trim().startsWith(name+'='))) {
			return true;
		} else {
			return false;
		}
	}
	function deleteAllCookies() {
		var cookies = document.cookie.split(";");

		for (var i = 0; i < cookies.length; i++) {
			var cookie = cookies[i];
			var eqPos = cookie.indexOf("=");
			var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
			document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
		}
	}
	$(function() {
		// destroyCookie("activity");
		// checkCookie("activity");
		var a = window.location.href;
		var hash = a.split('#')[1];
		console.log('hash: ' + hash);

		if(typeof hash  !== 'undefined'){
			// $("#"+hash).get(0).scrollIntoView(); 
			window.location.replace("#"+hash)
			$("#"+hash).effect("highlight", {color: '#dee9ec'}, 5000);
			window.history.replaceState(null, null, window.location.pathname);
		}

		var getVar = "{{app.request.query.all['s-t-h'] is defined ? app.request.query.all['s-t-h'] : 'nothing'}}";
		if(getVar == "scroll-myJobs"){
			getVar = "scroll-roles";
		} else if (getVar == "scroll-roles"){
			getVar = "scroll-jobs";
		}
		if(getVar != 'nothing'){
			console.log(getVar);
			// $("#"+getVar).get(0).scrollIntoView(); 
			window.location.replace("#"+getVar)
			$("#"+getVar).effect("highlight", {color: '#dee9ec'}, 5000);
			window.history.replaceState(null, null, window.location.pathname);
		}

		if(checkCookie("goto") == true){
			var goto = getCookie("goto");
			window.location.replace("#scroll-"+goto)
			$("#scroll-"+goto).effect("highlight", {color: '#dee9ec'}, 5000);
			window.history.replaceState(null, null, window.location.pathname);
			$("#info").hide();
			$("#skills").hide();
			$("#education").hide();
			$("#jobs").hide();
			$("#roles").hide();
			$("#projects").hide();
			$("#"+goto).show();

		}
		// $(window).bind('beforeunload', function(){
		// 	deleteAllCookies();
		// });
	});
	</script>
	<script>
		$(document).on("click", '[id^=goto-]', function(){

		var project = jQuery(this).attr("id");
		var splitted = project.split('-'); 
		var target = splitted[1];
		var saved = $("#saved").val();
		var form = "#"+target+"-form";

		setCookie("goto", target);
		// $("#child").animate({ scrollTop: parseInt($("#scroll-"+target).offset().top) }, "slow");
		// $("#scroll-"+target).get(0).scrollIntoView(); 
		window.location.replace("#scroll-"+target)
		$("#scroll-"+target).effect("highlight", {color: '#dee9ec'}, 5000);
		window.history.replaceState(null, null, window.location.pathname);

		if(saved){
			$("#info").hide();
			$("#skills").hide();
			$("#education").hide();
			$("#jobs").hide();
			$("#roles").hide();
			$("#projects").hide();
			$("#"+target).show();
			console.log("#"+target);
			// $("html, body").animate({ scrollTop: 0 }, "slow");
			$("#condition").show();
			$('#current').prop('selectedIndex', 0);
			$(form+" .init").focus();
		} else {
			alert ("Please save the basic information first");
		}

		});

	</script>

	<script>
		$(document).on("click", '[id^="to-"]', function(){

			var project = jQuery(this).attr("id");
			var splitted = project.split('-'); 
			var target = splitted[1];
			var from = splitted[3];
			var name = $('input[name ="fullname"]').val();
			var email = $('input[name ="email"]').val();
			var phone = $('input[name ="phone"]').val();
			var form = "#"+target+"-form";

			setCookie("goto", target);

			if(name && email && phone){
				$("#"+target).show();
				$("#"+from).hide();
				$("#"+target).parent().animate({ scrollTop: 0 }, "slow");
				$(form+" .init").focus();

				window.location.replace("#scroll-"+target)
				$("#scroll-"+target).effect("highlight", {color: '#dee9ec'}, 5000);
				window.history.replaceState(null, null, window.location.pathname);
			} else {
				alert ("Please provide the basic information - Name, Email and Phone number");
			}

		});

		$(document).on("click", '[id^="lets-scroll-"]', function(){

			var project = jQuery(this).attr("id");
			var splitted = project.split('-'); 
			var target = splitted[2];
			var scroll = "scroll-"+target;

			window.location.replace("#"+scroll);
			location.reload();

		});


	</script>

	<script>
    $(document).on("click", '[id^="url-"]', function(){
		
		// url-/admin/edit/jobs/job.id/false
		var project = jQuery(this).attr("id");
		var splitted = project.split('-'); 
		var sections = project.split("/");
		var div = sections[3];
		if(div == "myJobs"){
			div = "roles";
		} else if (div == "roles"){
			div = "jobs";
		}
		var scroll = "lets-scroll-"+div;

		var url = splitted[1];
		var iframe = document.getElementById('editor-frame');
		iframe.src = url;

		$(".reload").attr('id', scroll);

    });
	</script>

	<script>
    $(document).on("click", '[id^="save-"]', function(){
        var myId = jQuery(this).attr("id");
        var splitted = myId.split('-'); 
        var div = splitted[1];
        var id = splitted[2];
        var form = $("#"+div+"-form-"+id);
        saveDetails(div, "body", 'li', "", "-"+id);

        if($(form).attr('class') != 'referee-form'){
            form.trigger("reset");
        }

    });

</script>
<script>
	// $('body').on('click', 'a.myclass', function() {
	// 	// do something
	// });
	$("body").on("change keyup paste", 'input', function(){
		
		var classSelect = $(this).attr("class").match(/auto[\w-]*\b/);

		if(null !== classSelect){
			var splitted = classSelect[0].split('-'); 
			var name = splitted[1];
			var table = splitted[2];

			if (name == "startingfrom" ||  name == "endedin" ||  name == "fromyear" ||  name == "toyear"){
				
				var options = { month: 'short', year: 'numeric' };
				var datefstr  = new Date($(this).val());
				var today = new Date();

				if(today < datefstr){
					var val = "Ongoing";
				} else {
					var val = datefstr.toLocaleDateString("en-US", options);
				}

			} else {
				var val = $(this).val();
			}
			$('#'+name+'-'+table).text(val);
			console.log(name);

		}
	})

	$("textarea").on("change keyup paste", function(){
		var classSelect = $(this).attr("class").match(/auto[\w-]*\b/);
		if(null !== classSelect){
			var splitted = classSelect[0].split('-'); 
			var name = splitted[1];
			var table = splitted[2];
			$('#'+name+'-'+table).text($(this).val());
			console.log(name);
		}
	})

	$("select").on("change", function(){
		var classSelect = $(this).attr("class").match(/auto[\w-]*\b/);
		if(null !== classSelect){
			var splitted = classSelect[0].split('-'); 
			var name = splitted[1];
			var table = splitted[2];
			if ($(this).val() == "not_current") {
				var val = "";
				$('#endedin-'+table).text(val);
			} else if ($(this).val() == "current") {
				var val = "Present";
				$('#endedin-'+table).text(val);
			} else {
				var val = $(this).val();
			}

			$('#'+name+'-'+table).text(val);
			console.log(name);

		}
	})

</script>
	<script>
		$(document).on("click", '[id^="savedetail-"]', function(){
			var myId = jQuery(this).attr("id");
			var splitted = myId.split('-'); 
			var div = splitted[1];
			console.log(div);
			var form = $("#"+div+"-form");
			var notifyDiv = ".notify-"+div;
			var list = $("#"+div+"-list");
			var form_str = "#"+div+"-form";

			saveDetailsCV(div, notifyDiv);
			$("#"+div).parent().animate({ scrollTop: 0 }, "slow");
			$(form_str+" .init").focus();

			$.notify({
				icon: 'glyphicon glyphicon-time',
				message: 'Saving... You can add more!',
			},{
				element: "body",
				type: "info",
				allow_dismiss: true,
				delay: 1000,
				newest_on_top: false,
				placement: {
					from: 'bottom',
					align: 'center'
				}
			});
			$(form)[0].reset();
			
			$("#condition").show("slow");
			$('#current').prop('selectedIndex', 0);
		});

	</script>

	<script>
	$("#complete").click(function() {
		deleteAllCookies();
	});
	</script>

	<script>
	$( "#current" ).change(function() {
		var fact = $(this).val();
		if(fact == 'current'){
			var thisYear = new Date().getFullYear();
			$("#condition").hide("slow");
			$("#to_year_job").val(thisYear+'-12-31');
		} else {
			$("#condition").show("slow");
		}
		
	});

	</script>


	<script>
    $(document).ready(function() {
		console.log('initiated datepicker');
		$(".datepicker").datepicker( {
			format: "yyyy-mm",
			viewMode: "months", 
			minViewMode: "months"
		});    
    });
	</script>

<script>
    $(document).on("click", '[id^="save_"]', function(){

		$(this).prop('disabled', true);

    });
</script>

<script>

	$("#to-jobs-from-info").click(function() {
		saveDetails('info');
		// $(window).on('load',function(){
		$('#explain').modal('show');
		// });

	})

	$(".reload-and-preview").click(function() {

		setCookie("activity", "Preview");

		console.log('reloading iframe');
		var iframe = document.getElementById('resume-preview');
		iframe.src = iframe.src;

	})
	
	$(".close-preview").click(function() {

		destroyCookie("activity");

		reloadPage();
	})

</script>
<script>
	$('#from_year, #to_year, #from_year_job, #to_year_job').datepicker({
		startView: 4,
		minViewMode: 1,
		maxViewMode: 2,
		format: "yyyy-mm-dd",
	});
</script>
<script>
	function saveDetailsCV(div, target_element='body', append_type='button', append_class='btn btn-secondary', id = ""){

		// the form that will be serialized
		var form = $("#"+div+"-form"+id);

		// the list to be updated after successful ajax
		var list = $("#"+div+"-list"+id);

		// serialize the form and assign it to var form_data
		var form_data = $( form ).serializeArray();

		// validate the form 
		var valid = validateForm(form_data);
		console.log('valid: ' + valid);
		console.log(form_data);

		var plchld = $("#"+div+"-plc-hld");
		var cover = $("#"+div+"-cover");
		
		// if all forms are filled
		if(valid === true){

			// save the data through ajax
			$.ajax({
				url:'{{ (path("save_entity_cv")) }}',
				type: "POST",
				dataType: "json",
				data: form_data,
				async: true,
				success: function (data)
				{
					console.log('returned data : ' + data);
					$("#saved").val("true");

					if($('#mainbar').is(':visible')){
						// do nothing
					} else {
						$(".reload-and-preview").click();
						$('#preview').modal();
					}

					var newDiv = $( plchld ).clone().prop('id', 'newDiv' );
					newDiv.insertBefore( plchld );
					newDiv.find('span').removeClass(function (index, className) {
						return (className.match (/(^|\s)plc-hld-\S+/g) || []).join(' ');
					});
					newDiv.find('span').removeAttr('id');
					newDiv.append(data);
					newDiv.effect("highlight", {color: '#dee9ec'}, 5000);

					plchld.find('span').text("");
					$("#levelofskill-skills").text("Beginner");

					$.notify({
						icon: 'glyphicon glyphicon-ok',
						title: 'Success!',
						message: 'Information has been updated',
						url: '#',
						target: '_blank'
					},{
						element: "body",
						type: "success",
						allow_dismiss: true,
						newest_on_top: false,
						placement: {
							from: 'bottom',
							align: 'center'
						}
					});
				},
				error: function (err) {
					console.log("there is a problem: "+err.responseText);
					$.notify({
						icon: 'glyphicon glyphicon-warning-sign',
						title: 'Error!',
						message: 'Something is wrong',
					},{
						element: "body",
						type: "warning",
						allow_dismiss: true,
						newest_on_top: false,
						placement: {
							from: 'bottom',
							align: 'center'
						}
					});
				}
			});

		} else { // if not all the fields are filled

			$.notify({
				icon: 'glyphicon glyphicon-warning-sign',
				title: 'Error!',
				message: 'Please fill all the fields',
				url: '#',
				target: '_blank'
			},{
				element: "body",
				type: "warning",
				allow_dismiss: true,
				newest_on_top: true,
				placement: {
					from: 'bottom',
					align: 'center'
				}
			});

		}

	}	
</script>
<script>

	$(document).on('keypress', '[id^="submit-"]', function(e){
		var project = jQuery(this).attr("id");
		var splitted = project.split('-'); 
		var div = splitted[1];
		var key = e.which;
		if(key == 13)  // the enter key code
		{
			$("#savedetail-"+div).click();
			return false;  
		}
	});   

	$(document).on('keypress', '[id^="roleinput-"]', function(e){
		var project = jQuery(this).attr("id");
		var splitted = project.split('-'); 
		var id = splitted[1];
		var key = e.which;
		if(key == 13)  // the enter key code
		{
			// alert(id);
			$("#savedetail-role"+id).click();
			return false;  
		}
	});   

	function reloadPage() {

		location.reload();
		return false;

	}

	function showInfo() {
		$("#goto-info").click();
		$("#info-form").effect("highlight", {color: '#dee9ec'}, 5000);
		$("#profile").effect("highlight", {color: '#dee9ec'}, 5000);
	}
</script>

{% endblock %}